ultron_parity:
  ## telegraf exec command: mdcmd status | awk -F= 'BEGIN { printf "mdcmd,host=ultron " } $1~/^(mdResyncSize|mdResync|mdResyncPos|mdResyncDt|mdResyncDb)$/{ printf "%s=%s,", $1, $2 } END { printf "end=0" }'
  sensor:
    - platform: influxdb
      host: !secret influxdb_host
      username: !secret influxdb_username
      password: !secret influxdb_password
      queries:
        - name: "Ultron Parity Common Size Raw"
          unique_id: ultron_parity_common_size_raw
          value_template: "{{ value }}"
          group_function: last
          where: '"host" = ''ultron'''
          measurement: '"mdcmd"'
          field: mdResyncSize
          database: homelab_telegraf
        - name: "Ultron Parity Size Raw"
          unique_id: ultron_parity_size_raw
          value_template: "{{ value }}"
          group_function: last
          where: '"host" = ''ultron'''
          measurement: '"mdcmd"'
          field: mdResync
          database: homelab_telegraf
        - name: "Ultron Parity Pos Raw"
          unique_id: ultron_parity_pos_raw
          value_template: "{{ value }}"
          group_function: last
          where: '"host" = ''ultron'''
          measurement: '"mdcmd"'
          field: mdResyncPos
          database: homelab_telegraf
        - name: "Ultron Parity Dt Raw"
          unique_id: ultron_parity_dt_raw
          value_template: "{{ value }}"
          group_function: last
          where: '"host" = ''ultron'''
          measurement: '"mdcmd"'
          field: mdResyncDt
          database: homelab_telegraf
        - name: "Ultron Parity Db Raw"
          unique_id: ultron_parity_db_raw
          value_template: "{{ value }}"
          group_function: last
          where: '"host" = ''ultron'''
          measurement: '"mdcmd"'
          field: mdResyncDb
          database: homelab_telegraf

  template:
    - binary_sensor:
        - name: "Ultron Parity Check In Progress"
          device_class: running
          state: >-
            {% set progress = states('sensor.ultron_parity_progress') | float(0) %}
            {{ 0 < progress < 100 }}
          availability: >-
            {{ states('sensor.ultron_parity_progress') not in ['unknown', 'unavailable', 'none'] }}

        - name: "Ultron Parity Check Paused"
          state: >-
            {% set in_progress = is_state('binary_sensor.ultron_parity_check_in_progress', 'on') %}
            {% set size_is_zero = (states('sensor.ultron_parity_size_raw') | int(0)) == 0 %}
            {{ size_is_zero and in_progress }}
          availability: >-
            {% set valid_size = states('sensor.ultron_parity_size_raw') | int(-1) >= 0 %}
            {% set valid_in_progress = states('binary_sensor.ultron_parity_check_in_progress') in ['on', 'off'] %}
            {{ valid_size and valid_in_progress }}

    - sensor:
        - name: "Ultron Parity Progress"
          unit_of_measurement: "%"
          state_class: measurement
          state: >-
            {% set parity_common_size = states('sensor.ultron_parity_common_size_raw') | int(0) %}
            {% set parity_size = states('sensor.ultron_parity_size_raw') | int(0) %}
            {% set parity_pos = states('sensor.ultron_parity_pos_raw') | int(0) %}
            {% if parity_size == 0 %}
              {% if parity_pos == 0 %}
                100
              {% else %}
                {{ (parity_pos / parity_common_size * 100) | round(2) }}
              {% endif %}
            {% else %}
              {{ (parity_pos / parity_size * 100) | round(2) }}
            {% endif %}
          availability: >-
            {% set valid_parity_common_size = states('sensor.ultron_parity_common_size_raw') | int(0) > 0 %}
            {% set valid_parity_size = states('sensor.ultron_parity_size_raw') | int(-1) >= 0 %}
            {% set valid_parity_pos = states('sensor.ultron_parity_pos_raw') | int(-1) >= 0 %}
            {{ valid_parity_common_size and valid_parity_size and valid_parity_pos }}

        - name: "Ultron Parity Speed"
          device_class: data_rate
          unit_of_measurement: "MB/s"
          state_class: measurement
          state: >-
            {% set parity_db = states('sensor.ultron_parity_db_raw') | int(0) %}
            {% set parity_dt = states('sensor.ultron_parity_dt_raw') | int(0) %}
            {% if parity_dt == 0 %}
              0
            {% else %}
              {{ (parity_db / parity_dt * 1024 / 1e6) | round(1) }}
            {% endif %}
          availability: >-
            {% set valid_parity_db = states('sensor.ultron_parity_db_raw') | int(-1) >= 0 %}
            {% set valid_parity_dt = states('sensor.ultron_parity_dt_raw') | int(-1) >= 0 %}
            {{ valid_parity_db and valid_parity_dt }}

        - name: "Ultron Parity Finish Timestamp"
          device_class: timestamp
          state: >-
            {% set parity_db = states('sensor.ultron_parity_db_raw') | float(0) %}
            {% set parity_dt = states('sensor.ultron_parity_dt_raw') | float(0) %}
            {% set parity_size = states('sensor.ultron_parity_size_raw') | float(0) %}
            {% set parity_pos = states('sensor.ultron_parity_pos_raw') | float(0) %}
            {% set seconds = ((parity_size - parity_pos) * parity_dt / parity_db) | round(0) %}
            {{ now() + timedelta(seconds=seconds) }}
          availability: >-
            {% set valid_parity_db = states('sensor.ultron_parity_db_raw') | int(0) > 0 %}
            {% set valid_parity_size = states('sensor.ultron_parity_size_raw') | int(0) > 0 %}
            {{ valid_parity_db and valid_parity_size }}
        - name: "Ultron Parity Status"
          state: >-
            {% set in_progress = is_state('binary_sensor.ultron_parity_check_in_progress', 'on') %}
            {% set paused = is_state('binary_sensor.ultron_parity_check_paused', 'on') %}
            {% if paused %}
              paused
            {% elif in_progress %}
              running
            {% else %}
              finished
            {% endif %}
          icon: >-
            {% set status = states('sensor.ultron_parity_status') %}
            {% if status == 'paused' %}
              mdi:pause
            {% elif status == 'running' %}
              mdi:play
            {% else %}
              mdi:stop
            {% endif %}
