ultron_vm:
  sensor:
    - platform: influxdb
      host: !secret influxdb_host
      username: !secret influxdb_username
      password: !secret influxdb_password
      queries:
        - name: "VM HTPC State"
          unique_id: c_ultron_vm_htpc_state
          value_template: "{{ value }}"
          group_function: last
          where: '"vm" = ''HTPC'' AND "host" = ''ultron'''
          measurement: '"virsh"'
          field: state
          database: homelab_telegraf

        - name: "VM Fedora State"
          unique_id: c_ultron_vm_fedora_state
          value_template: "{{ value }}"
          group_function: last
          where: '"vm" = ''Fedora'' AND "host" = ''ultron'''
          measurement: '"virsh"'
          field: state
          database: homelab_telegraf

  shell_command:
    start_ultron_vm_htpc: "ssh -i /config/ultron.key -o StrictHostKeyChecking=no root@{{ states('sensor.ultron_ip') }} virsh start 'HTPC'"
    shutdown_ultron_vm_htpc: "ssh -i /config/ultron.key -o StrictHostKeyChecking=no root@{{ states('sensor.ultron_ip') }} virsh shutdown 'HTPC'"
    start_ultron_vm_fedora: "ssh -i /config/ultron.key -o StrictHostKeyChecking=no root@{{ states('sensor.ultron_ip') }} virsh start 'Fedora'"
    shutdown_ultron_vm_fedora: "ssh -i /config/ultron.key -o StrictHostKeyChecking=no root@{{ states('sensor.ultron_ip') }} virsh shutdown 'Fedora'"

  template:
  - switch:
    - name: VM HTPC
      default_entity_id: switch.c_ultron_vm_htpc
      state: '{{ is_state(''sensor.vm_htpc_state'', ''running'') }}'
      icon: mdi:microsoft-windows
      turn_on:
      - action: shell_command.start_ultron_vm_htpc
      turn_off:
      - action: shell_command.shutdown_ultron_vm_htpc

    - name: VM Fedora
      default_entity_id: switch.c_ultron_vm_fedora
      state: '{{ is_state(''sensor.vm_fedora_state'', ''running'') }}'
      icon: mdi:fedora
      turn_on:
      - action: shell_command.start_ultron_vm_fedora
      turn_off:
      - action: shell_command.shutdown_ultron_vm_fedora

  command_line:
    - switch:
        unique_id: ultron_server
        name: "Ultron Server"
        command_on: "ssh -i /config/ultron.key -o StrictHostKeyChecking=no root@{{ states('sensor.ultron_ip') }} start"
        command_off: "ssh -i /config/ultron.key -o StrictHostKeyChecking=no root@192.168.1.11 shutdown -h now"
        command_state: "echo 0"
        icon: mdi:server
